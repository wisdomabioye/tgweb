{"version":3,"sources":["../../../src/service/api-manager/error-cases.js"],"names":["cachedExportPromise","protect","code","NaN","type","rawError","dcID","baseDcID","base","errR","patterns","noBaseAuth","noDcAuth","waitFail","_","matchProtect","matched","error","options","emit","rejectPromise","requestThunk","apiSavedNet","apiRecall","deferResolve","mtpInvokeApi","storage","invoke","throwNext","reject","importAuth","id","bytes","noErrorBox","exportDeferred","dc_id","then","resolve","catch","promise","now","stopTime","waitTime","Math","min","def","switchErrors"],"mappings":"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","file":"error-cases.js","sourcesContent":["import isNil from 'ramda/src/isNil'\nimport propOr from 'ramda/src/propOr'\n\nimport blueDefer from '../../util/defer'\nimport Switch from '../../util/switch'\nimport { tsNow } from '../time-manager'\n\nconst cachedExportPromise = {}\n\nconst protect = (\n    { code = NaN, type = '' },\n    { rawError = null },\n    dcID,\n    baseDcID\n  ) => ({\n    base: baseDcID,\n    errR: rawError,\n    code,\n    type,\n    dcID\n  })\n\nconst patterns = {\n  noBaseAuth: ({ code, dcID, base })  =>  code === 401 && dcID === base,\n  noDcAuth  : ({ code, dcID, base })  =>  code === 401 && dcID !== base,\n  waitFail  : ({ code, type, errR })  =>  !errR && (code === 500 || type === 'MSG_WAIT_FAILED'),\n  _         : ()                      =>  true\n}\n\n\nconst matchProtect =\n  matched => (\n      error,\n      options,\n      dcID,\n      emit,\n      rejectPromise,\n      requestThunk,\n      apiSavedNet,\n      apiRecall,\n      deferResolve,\n      mtpInvokeApi,\n      storage\n    ) =>\n      matched({\n        invoke   : mtpInvokeApi,\n        throwNext: () => rejectPromise(error),\n        reject   : rejectPromise,\n        options,\n        dcID,\n        emit,\n        requestThunk,\n        apiRecall,\n        deferResolve,\n        apiSavedNet,\n        storage\n      })\n\n\nconst noBaseAuth = ({ emit, throwNext, storage }) => {\n  // storage.remove('dc', 'user_auth')\n  emit('error.401.base')\n  throwNext()\n}\n\nconst noDcAuth = ({ dcID, reject, apiSavedNet, apiRecall, deferResolve, invoke }) => {\n  const importAuth = ({ id, bytes }) => invoke(\n    'auth.importAuthorization',\n    { id, bytes },\n    { dcID, noErrorBox: true })\n\n\n  if (isNil(cachedExportPromise[dcID])) {\n    const exportDeferred = blueDefer()\n\n    invoke(\n      'auth.exportAuthorization',\n      { dc_id: dcID },\n      { noErrorBox: true })\n\n      .then(importAuth)\n      .then(exportDeferred.resolve)\n      .catch(exportDeferred.reject)\n\n    cachedExportPromise[dcID] = exportDeferred.promise\n  }\n\n\n\n  cachedExportPromise[dcID] //TODO not returning promise\n    .then(apiSavedNet)\n    .then(apiRecall)\n    .then(deferResolve)\n    .catch(reject)\n}\n/*\nconst migrate = ({ error, dcID, options, reject,\n    apiRecall, deferResolve, getNet, storage\n  }) => {\n  const newDcID = error.type.match(/^(PHONE_MIGRATE_|NETWORK_MIGRATE_|USER_MIGRATE_)(\\d+)/)[2]\n  if (newDcID === dcID) return\n  if (options.dcID)\n    options.dcID = newDcID\n  else\n    storage.set('dc', newDcID)\n\n  getNet(newDcID, options)\n    .then(apiRecall)\n    .then(deferResolve)\n    .catch(reject)\n}*/\n\n/*const floodWait = ({ error, options, throwNext, requestThunk }) => {\n  const waitTime = error.type.match(/^FLOOD_WAIT_(\\d+)/)[1] || 10\n  if (waitTime > (options.timeout || 60))\n    return throwNext()\n  requestThunk(waitTime)\n}*/\n\nconst waitFail = ({ options, throwNext, requestThunk }) => {\n  const now = tsNow()\n  if (options.stopTime) {\n    if (now >= options.stopTime)\n      return throwNext()\n  } else\n    options.stopTime = now + propOr(10, 'timeout', options) * 1000\n  options.waitTime = options.waitTime\n    ? Math.min(60, options.waitTime * 1.5)\n    : 1\n  requestThunk(options.waitTime)\n}\n\nconst def = ({ throwNext }) => throwNext()\n\n\nexport const switchErrors = Switch(patterns, protect)({\n  noBaseAuth,\n  noDcAuth,\n  waitFail,\n  _: def\n}, matchProtect)"]}